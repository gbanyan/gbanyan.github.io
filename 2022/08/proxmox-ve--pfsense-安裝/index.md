# Proxmox VE + PfSense å®‰è£


## å‰è¨€

å®¶ä¸­çš„è»Ÿè·¯ç”±æ©Ÿå™¨æœ¬åªæœ‰å®‰è£ OpenWRT, ä¹Ÿç¨±è·åœ°å·¥ä½œäº†ä¸€æ®µæ™‚é–“ã€‚å¶ç„¶æ³¨æ„åˆ°ï¼Œç¶²è·¯é«˜è² è¼‰çš„æƒ…æ³ä¸‹ï¼Œè¨˜æ†¶é«”ä½”ç”¨ä¹Ÿæ‰åƒ… 8GB è¨˜æ†¶é«”çš„ 1% è€Œå·²ã€‚ç¡¬é«”è³‡æºä¸¦æ²’æœ‰å¥½å¥½è¢«å¦¥å–„ä½¿ç”¨ï¼Œå·¥ç¨‹é­‚å°±ç‡ƒç‡’èµ·ä¾†æƒ³æ¦¨ä¹¾ä»–ã€‚

ä¸€ç¨®æŽ¨è–¦é…ç½®æ˜¯å®‰è£ Proxmox VE ç’°å¢ƒï¼Œå†è™›æ“¬åŒ– Router è»Ÿé«”ï¼Œå‰©ä¸‹çš„è³‡æºå°±å¯ä»¥å®‰è£å…¶ä»–å®¢é«”ä½œæ¥­ç³»çµ±å¦‚ Windows, Linux, æˆ–è€…å†è£ docker æœå‹™ã€‚

## Proxmox VE å®‰è£ pfSense

å®‰è£ Proxmox æœ¬èº«çš„éŽç¨‹è »ç°¡å–®ï¼Œä¸‹è¼‰ ISO æª”ï¼Œç‡’éŒ„åˆ° USB éš¨èº«ç¢Ÿï¼Œå•Ÿå‹•ä¸€æ­¥ä¸€æ­¥å®‰è£å³å¯ã€‚åœ¨é«˜æª”ç¡¬é«”é…ç½®çš„é‡åž‹ä¼ºæœå™¨ï¼Œé‚„å¯ä»¥è€ƒæ…® ZFS æª”æ¡ˆç³»çµ±ï¼Œä¸éŽåªæ˜¯ä¸€å°è»Ÿè·¯ç”±å°ä¸»æ©Ÿå°±ä¸€åˆ‡å¾žç°¡ã€‚

ä¸‹è¼‰ pfSense iso æª”ï¼Œä¸Šå‚³åˆ° Proxmox VEï¼Œå°±å¯ä»¥å®‰è£äº†ã€‚pfSense çš„å®‰è£ä¹Ÿæœ‰ä¸å°‘æ•™å­¸æ–‡ï¼Œç”šè‡³å®˜æ–¹ä¹Ÿæœ‰[èªªæ˜Žæ–‡ä»¶(Virtualizing with ProxmoxÂ® VE)](https://docs.netgate.com/pfsense/en/latest/recipes/virtualize-proxmox-ve.html)ã€‚ä»¥ä¸‹åƒ…è¨Žè«–å€‹äººéœ€æ±‚å’Œæž¶è¨­éŽç¨‹ä¸­çš„å•é¡Œã€‚

### é è¨ˆæž¶æ§‹

- è»Ÿè·¯ç”±æ©Ÿå™¨æœ‰å››å€‹å¯¦é«”ç¶²è·¯å­”, enp1s0, enp2s0, enp3s0, enp4s0
- ç¬¬ä¸€å€‹ç•¶ä½œ WAN å­”ï¼Œå…¶é¤˜ä¸‰å­”ä½œç‚º LAN å­”
- Proxmox VE å¯ä»¥é€éŽ LAN å­”å­˜å–
- Proxmox VE ä¹‹ä¸‹è™›æ“¬åŒ–çš„ pfSense ä½œç‚º Router ä½¿ç”¨ï¼Œé€éŽ WAN é€²è¡Œ PPPoE æ’¥è™Ÿ
- å®¶ä¸­å…¶é¤˜ç¶²è·¯è¨­å‚™é€éŽ LAN å¾—åˆ°ç¶²è·¯å­˜å–

### å•é¡Œé»ž

- ä¸€é–‹å§‹ Proxmox VE å·²ç¶“å»ºç«‹ä¸€å€‹ Linux Bridge, ç‚º vmbr0, é—œè¯åˆ° enp1s0, ä¸¦å·²æŒ‡æ´¾åŽŸå…ˆè¨­å®šçš„ IP 192.168.100.2
- é›»è…¦ç«¯åªèƒ½é€éŽç·šè·¯é€£æŽ¥åˆ° enp1s0 é€²è¡Œ Proxmox VE çš„è¨­å®š
- å°‡å…¶ä»–å¯¦é«”ç¶²è·¯æŽ¥å­” enp2s0, enp3s0, enp4s0 é—œè¯åˆ° vmbr1
- Pfsense æž¶è¨­å®Œæˆä»¥å¾Œï¼Œå¯ä»¥é€éŽ vmbr0 æŒ‡å®šåˆ° WAN, vmbr1 æŒ‡å®šåˆ° LANï¼Œæ­£å¸¸é€²è¡Œç¶²è·¯æ’¥æŽ¥åŠå€åŸŸç¶²è·¯åˆ†æ´¾ã€‚ä½†æ­¤ä¸€ç’°å¢ƒç›´æŽ¥æ‹¿åŽ»ä½¿ç”¨ï¼Œç„¡æ³•å¾žä»»ä½•å·²ç¶“é€£çµåˆ° LAN çš„æ©Ÿå™¨é€²å…¥ Proxmox VE ç®¡ç†ä»‹é¢
- æŽ¥çºŒä¸Šè¿°ï¼Œå¦‚æžœè¦é€²è¡Œ Proxmox VE çš„ç®¡ç†ï¼Œè¦æ•´å°æ©Ÿå™¨æ‹¿ä¸‹ä¾†ï¼Œé€éŽ enp1s0 é€²è¡Œé€£æŽ¥ï¼Œååˆ†ä¸ä¾¿

### è§£æ±ºæ–¹æ³•

ç¶“éŽç ”ç©¶åŠå¤©ï¼Œé‚„æ›¾ç¶“ä¸€åº¦æžåˆ°ä¸­é€”æ–·é›»è¨­å®šé»¨æ•´å€‹ä¸ŸæŽ‰ç„¡æ³•é–‹æ©Ÿçš„çª˜æ³ï¼Œè¦é‡çŒ Proxmox VE çš„ç‹€æ³ï¼Œç¸½ç®—æžå®šäº†â€¦ ðŸ¤·â€â™‚ï¸

- å–æ¶ˆ vmbr0 çš„ é è¨­ IP èˆ‡ Gatewayï¼Œæ”¹è¨­åˆ° vmbr1
- æŒ‡æ´¾ vmbr1 çš„ IP è¨­å®šåˆ°èˆ‡ Pfsense LAN åŒä¸€ç¶²æ®µ, Gateway æŒ‡å‘ Pfeense 192.168.1.1
	- pfSense é è¨­çš„ DHCP range ç‚º 192.168.1.100 ~

é€™æ¨£å°±å¯ä»¥é€éŽ Pfsense çš„ LAN å­”å­˜å– Proxmox VE äº†

![](/images/ProxmoxVE_network.png)

![](/images/Proxmox.drawio.png)

### æ½›åœ¨å•é¡Œ

- Proxmox VE ä¸»æ©Ÿå¿…é ˆè¦é€éŽ pfSenese æ‰èƒ½é€£åˆ°å¤–ç¶²
- pfSense ä¸€æ—¦æŽ›æŽ‰ ã€é·ç§»ä¸­åœæ­¢ã€ æˆ–å…¶ä»–ç¶­è­·ç­‰å› ç´ ï¼Œæ‰€æœ‰è£ç½®åŒ…å« Proxmox VE ä¸»æ©Ÿå°±æœ‰å¯èƒ½ç„¡æ³•é€£ç·š

## pfSense vs OpenWRT

ä»¥ç”¢å“ç›®æ¨™ä¾†äº†è§£ç™¼å±•è„ˆçµ¡ï¼Œä¸ä¸€å®šè¦åµè¨Žè«–ç‰¹å®šç”¨é€”åŸ·å„ªåŸ·åŠ£

### pfSense

- FreeBSD ç‚ºåŸºåº•ï¼Œä»¥å°ˆæ¥­é˜²ç«ç‰†ç›®æ¨™ç‚ºè¨­è¨ˆ
- é˜²ç«ç‰†ç®¡ç†åŠŸèƒ½ä¸€æ‡‰ä¿±å…¨ï¼Œç®¡ç†ç›£æ¸¬åŠŸèƒ½å®Œæ•´
- ä½¿ç”¨è€…ä»‹é¢æ¢ç†åˆ†æ˜Žï¼Œèªªæ˜Žæ–‡å­—æ¸…æ¥š
- Netgate å…¬å¸æä¾›å•†æ¥­ä»˜è²»æ”¯æ´ï¼Œå®Œå–„çš„èªªæ˜Žæ–‡ä»¶ï¼Œä¸”æœ‰å„æ‡‰ç”¨å ´æ™¯ scene çš„ç›¸å°æ‡‰åƒè€ƒæ–‡ä»¶

### OpenWRT

- Linux ç‚ºåŸºç¤Žï¼Œä»¥å°åž‹åµŒå…¥å¼è£ç½®ç‚ºå°Žå‘ï¼Œé©åˆç¡¬é«”è³‡æºç›¸å°ä½Žçš„å®¶ç”¨ç„¡ç·šè·¯ç”±å™¨
- å°åž‹è¼•é‡ï¼Œé™¤åŸºæœ¬åŠŸèƒ½å¤–ï¼Œå¯ä»¥è‡ªè¡Œé€éŽ opkg å®‰è£ç¤¾ç¾¤ç¶­è­·çš„å¥—ä»¶
- ä¹Ÿæœ‰èªªæ˜Žæ–‡ä»¶ï¼Œä½†æ˜¯æ²’æœ‰åƒ Netgate ç‚º pfSense ç¶­è­·çš„æ–‡ä»¶é‚£éº¼ä½¿ç”¨è€…å°Žå‘
	- ç¶²è·¯ç›¸é—œåŸºç¤ŽçŸ¥è­˜æ‰èƒ½ç†è§£ï¼Œæˆ–æœªæä¾›ç´°ç¯€èªªæ˜Žï¼Œéœ€å°‹æ‰¾æ›´å¤šè¨Žè«–æ–‡ç« ä»¥å°‹æ±‚è§£ç­”
	- è¨Žè«–æ–‡ç« ä¹Ÿä¸ä¸€å®šæä¾›æ­£ç¢ºç­”æ¡ˆï¼Œéœ€ä»°è³´è‡ªå·±æ‘¸ç´¢ã€‚

æˆ‘è¦ºå¾—å…©å€‹ç³»çµ±éƒ½å¾ˆå„ªç§€ï¼Œå¦‚æžœæ˜¯ä¸€å°ç„¡ç·šè·¯ç”±å™¨æˆ–ç¡¬é«”é…ç½®å¾ˆä½Žçš„æ©Ÿå™¨è¦æ”¹è£ï¼Œæˆ‘æœƒå„ªå…ˆé¸æ“‡ OpenWRTã€‚ä½†æ˜¯åƒå››æ ¸å¿ƒ J1900 CPU, è¨˜æ†¶é«”è£åˆ° 8G çš„æ©Ÿå™¨ï¼Œå°±æœƒè€ƒæ…®è£ pfSense ä¾†çŽ©çŽ©ã€‚

## Reference

- [åœ¨ UniFi Controller 5.9.29 å•Ÿç”¨ä¸­è¯é›»ä¿¡éžå›ºå®šåˆ¶ IPv6 æœå‹™](https://www.jkg.tw/p1464/)
- [pfBlockerNGè®¾ç½®æŒ‡å— | éµè¡€ç”·å…’çš„BLOG](https://pfschina.org/wp/?p=6505#IPv4%E6%8A%91%E5%88%B6%E5%88%97%E8%A1%A8)
- [pfSenseå®‰è£…AdGuardHome | éµè¡€ç”·å…’çš„BLOG](https://pfschina.org/wp/?p=6686)


---

> ä½œè€…: Gbanyan  
> URL: https://huyan.gbanyan.net/2022/08/proxmox-ve--pfsense-%E5%AE%89%E8%A3%9D/  

