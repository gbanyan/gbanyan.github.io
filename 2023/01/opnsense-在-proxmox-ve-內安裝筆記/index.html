<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OPNsense 在 Proxmox VE 內安裝筆記 | 世界樹下，霍德爾之目</title><meta name=keywords content="Linux,FreeBSD"><meta name=description content="前言 更換了軟路由硬體故順便更新了筆記 此篇繼承了 Proxmox VE + PfSense 安裝 在 Proxmox VE 內的網路安裝架構仍然類似，皆採用半虛擬化網卡 Virtio Net 的架構 經過測試，Intel J4125 搭配 Intel i225v 網卡， 不用設定網卡直通，也可以跑滿 300M / 100M 更換成 OPNsense 原因有以下考量： PfSense 需要訂閱 (PfSense Plus) 才會獲得較積極的更新，雖然個人用戶目前免費，但不排除未來需付費可能 OPNsense 的更新策略較為積極，安全性更新週期較短 可安裝 Zenarmor 以及其他第三方套件來源，雖然後面還是把 Zenarmor 移除了 OPNsense 的 UI 比較人性化一些，可以善用搜尋快速跳到自己想要的設定欄位 初始安裝 Installation Assign the Port vmbr0 to WAN and vmbr1 to LAN (參見 PfSense 筆記內圖片) Skip the lagg and vlan configuration Default account and password for enter installation account: installer pass; opnsense Proxmox VE 內 VM 的設定 machine type: Q35 processors type: host OS type: other 其他 CPU, memory 視需求調整 設定 Configuration PPPoE settings with IPv6 (適用 Hinet) Fill out PPPoE info to establish connection Tick &ldquo;Use IPv4 connectivity option&rdquo; at LAN IPv6 section, IPv6 configuration type -> Track Interface, and the options below interface select &ldquo;WAN&rdquo; In the Firewall options, Tick &ldquo;allow IPv6&rdquo; Add IPv6 ICMP allow rule in WAN firewall rule 如果想指定自架的 DNS (Adguard Home or Pi-Hole) 且想要應用到 IPv6: Tick the &ldquo;Manual Router announcement management&rdquo; Fill the DNS IPv4 settings in the &ldquo;Router announcement&rdquo; Hinet IPv6 is Stateless (Stateless DHCPv6 + SLAAC) Disable the DHCPv6 service in the LAN 這樣做的邏輯是，IPv6 DNS 可以只向 IPv4 位址的 DNS 伺服器請求，還是會回傳 IPv6 的解析位址 安全性設定 Security System Disable the listen service including WebUI, ssh, Unbound on WAN surface Install the CrowdSec, and enable Intrusion Detection Disable hardware net acceleration related &ldquo;Interfaces&rdquo; > &ldquo;Settings&rdquo; Configure the SSH Key, disable the password login Intrusion Detection (Suricata) (IPS/IDS) Download rule sets based on service used Rule set with using sites name (p2p, Facebook, Youtube) do not apply ET Pro rule set need suscription Crowdesc Connected to the cloud database to detect the attackers IPs and block Collection for different scenarios (windows, nginx, &mldr;)can only be added through shell command The hub for adding the scenario rule Hub | Firehol IP list subscription FireHOL Block List ( Botnets, Attacks, Malware&mldr;."><meta name=author content><link rel=canonical href=https://huyan.gbanyan.net/2023/01/opnsense-%E5%9C%A8-proxmox-ve-%E5%85%A7%E5%AE%89%E8%A3%9D%E7%AD%86%E8%A8%98/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://huyan.gbanyan.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://huyan.gbanyan.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://huyan.gbanyan.net/favicon-32x32.png><link rel=apple-touch-icon href=https://huyan.gbanyan.net/apple-touch-icon.png><link rel=mask-icon href=https://huyan.gbanyan.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="OPNsense 在 Proxmox VE 內安裝筆記"><meta property="og:description" content="前言 更換了軟路由硬體故順便更新了筆記 此篇繼承了 Proxmox VE + PfSense 安裝 在 Proxmox VE 內的網路安裝架構仍然類似，皆採用半虛擬化網卡 Virtio Net 的架構 經過測試，Intel J4125 搭配 Intel i225v 網卡， 不用設定網卡直通，也可以跑滿 300M / 100M 更換成 OPNsense 原因有以下考量： PfSense 需要訂閱 (PfSense Plus) 才會獲得較積極的更新，雖然個人用戶目前免費，但不排除未來需付費可能 OPNsense 的更新策略較為積極，安全性更新週期較短 可安裝 Zenarmor 以及其他第三方套件來源，雖然後面還是把 Zenarmor 移除了 OPNsense 的 UI 比較人性化一些，可以善用搜尋快速跳到自己想要的設定欄位 初始安裝 Installation Assign the Port vmbr0 to WAN and vmbr1 to LAN (參見 PfSense 筆記內圖片) Skip the lagg and vlan configuration Default account and password for enter installation account: installer pass; opnsense Proxmox VE 內 VM 的設定 machine type: Q35 processors type: host OS type: other 其他 CPU, memory 視需求調整 設定 Configuration PPPoE settings with IPv6 (適用 Hinet) Fill out PPPoE info to establish connection Tick &ldquo;Use IPv4 connectivity option&rdquo; at LAN IPv6 section, IPv6 configuration type -> Track Interface, and the options below interface select &ldquo;WAN&rdquo; In the Firewall options, Tick &ldquo;allow IPv6&rdquo; Add IPv6 ICMP allow rule in WAN firewall rule 如果想指定自架的 DNS (Adguard Home or Pi-Hole) 且想要應用到 IPv6: Tick the &ldquo;Manual Router announcement management&rdquo; Fill the DNS IPv4 settings in the &ldquo;Router announcement&rdquo; Hinet IPv6 is Stateless (Stateless DHCPv6 + SLAAC) Disable the DHCPv6 service in the LAN 這樣做的邏輯是，IPv6 DNS 可以只向 IPv4 位址的 DNS 伺服器請求，還是會回傳 IPv6 的解析位址 安全性設定 Security System Disable the listen service including WebUI, ssh, Unbound on WAN surface Install the CrowdSec, and enable Intrusion Detection Disable hardware net acceleration related &ldquo;Interfaces&rdquo; > &ldquo;Settings&rdquo; Configure the SSH Key, disable the password login Intrusion Detection (Suricata) (IPS/IDS) Download rule sets based on service used Rule set with using sites name (p2p, Facebook, Youtube) do not apply ET Pro rule set need suscription Crowdesc Connected to the cloud database to detect the attackers IPs and block Collection for different scenarios (windows, nginx, &mldr;)can only be added through shell command The hub for adding the scenario rule Hub | Firehol IP list subscription FireHOL Block List ( Botnets, Attacks, Malware&mldr;."><meta property="og:type" content="article"><meta property="og:url" content="https://huyan.gbanyan.net/2023/01/opnsense-%E5%9C%A8-proxmox-ve-%E5%85%A7%E5%AE%89%E8%A3%9D%E7%AD%86%E8%A8%98/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-29T18:46:18+08:00"><meta property="article:modified_time" content="2023-01-29T18:46:18+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="OPNsense 在 Proxmox VE 內安裝筆記"><meta name=twitter:description content="前言 更換了軟路由硬體故順便更新了筆記 此篇繼承了 Proxmox VE + PfSense 安裝 在 Proxmox VE 內的網路安裝架構仍然類似，皆採用半虛擬化網卡 Virtio Net 的架構 經過測試，Intel J4125 搭配 Intel i225v 網卡， 不用設定網卡直通，也可以跑滿 300M / 100M 更換成 OPNsense 原因有以下考量： PfSense 需要訂閱 (PfSense Plus) 才會獲得較積極的更新，雖然個人用戶目前免費，但不排除未來需付費可能 OPNsense 的更新策略較為積極，安全性更新週期較短 可安裝 Zenarmor 以及其他第三方套件來源，雖然後面還是把 Zenarmor 移除了 OPNsense 的 UI 比較人性化一些，可以善用搜尋快速跳到自己想要的設定欄位 初始安裝 Installation Assign the Port vmbr0 to WAN and vmbr1 to LAN (參見 PfSense 筆記內圖片) Skip the lagg and vlan configuration Default account and password for enter installation account: installer pass; opnsense Proxmox VE 內 VM 的設定 machine type: Q35 processors type: host OS type: other 其他 CPU, memory 視需求調整 設定 Configuration PPPoE settings with IPv6 (適用 Hinet) Fill out PPPoE info to establish connection Tick &ldquo;Use IPv4 connectivity option&rdquo; at LAN IPv6 section, IPv6 configuration type -> Track Interface, and the options below interface select &ldquo;WAN&rdquo; In the Firewall options, Tick &ldquo;allow IPv6&rdquo; Add IPv6 ICMP allow rule in WAN firewall rule 如果想指定自架的 DNS (Adguard Home or Pi-Hole) 且想要應用到 IPv6: Tick the &ldquo;Manual Router announcement management&rdquo; Fill the DNS IPv4 settings in the &ldquo;Router announcement&rdquo; Hinet IPv6 is Stateless (Stateless DHCPv6 + SLAAC) Disable the DHCPv6 service in the LAN 這樣做的邏輯是，IPv6 DNS 可以只向 IPv4 位址的 DNS 伺服器請求，還是會回傳 IPv6 的解析位址 安全性設定 Security System Disable the listen service including WebUI, ssh, Unbound on WAN surface Install the CrowdSec, and enable Intrusion Detection Disable hardware net acceleration related &ldquo;Interfaces&rdquo; > &ldquo;Settings&rdquo; Configure the SSH Key, disable the password login Intrusion Detection (Suricata) (IPS/IDS) Download rule sets based on service used Rule set with using sites name (p2p, Facebook, Youtube) do not apply ET Pro rule set need suscription Crowdesc Connected to the cloud database to detect the attackers IPs and block Collection for different scenarios (windows, nginx, &mldr;)can only be added through shell command The hub for adding the scenario rule Hub | Firehol IP list subscription FireHOL Block List ( Botnets, Attacks, Malware&mldr;."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://huyan.gbanyan.net/posts/"},{"@type":"ListItem","position":3,"name":"OPNsense 在 Proxmox VE 內安裝筆記","item":"https://huyan.gbanyan.net/2023/01/opnsense-%E5%9C%A8-proxmox-ve-%E5%85%A7%E5%AE%89%E8%A3%9D%E7%AD%86%E8%A8%98/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OPNsense 在 Proxmox VE 內安裝筆記","name":"OPNsense 在 Proxmox VE 內安裝筆記","description":"前言 更換了軟路由硬體故順便更新了筆記 此篇繼承了 Proxmox VE + PfSense 安裝 在 Proxmox VE 內的網路安裝架構仍然類似，皆採用半虛擬化網卡 Virtio Net 的架構 經過測試，Intel J4125 搭配 Intel i225v 網卡， 不用設定網卡直通，也可以跑滿 300M / 100M 更換成 OPNsense 原因有以下考量： PfSense 需要訂閱 (PfSense Plus) 才會獲得較積極的更新，雖然個人用戶目前免費，但不排除未來需付費可能 OPNsense 的更新策略較為積極，安全性更新週期較短 可安裝 Zenarmor 以及其他第三方套件來源，雖然後面還是把 Zenarmor 移除了 OPNsense 的 UI 比較人性化一些，可以善用搜尋快速跳到自己想要的設定欄位 初始安裝 Installation Assign the Port vmbr0 to WAN and vmbr1 to LAN (參見 PfSense 筆記內圖片) Skip the lagg and vlan configuration Default account and password for enter installation account: installer pass; opnsense Proxmox VE 內 VM 的設定 machine type: Q35 processors type: host OS type: other 其他 CPU, memory 視需求調整 設定 Configuration PPPoE settings with IPv6 (適用 Hinet) Fill out PPPoE info to establish connection Tick \u0026ldquo;Use IPv4 connectivity option\u0026rdquo; at LAN IPv6 section, IPv6 configuration type -\u0026gt; Track Interface, and the options below interface select \u0026ldquo;WAN\u0026rdquo; In the Firewall options, Tick \u0026ldquo;allow IPv6\u0026rdquo; Add IPv6 ICMP allow rule in WAN firewall rule 如果想指定自架的 DNS (Adguard Home or Pi-Hole) 且想要應用到 IPv6: Tick the \u0026ldquo;Manual Router announcement management\u0026rdquo; Fill the DNS IPv4 settings in the \u0026ldquo;Router announcement\u0026rdquo; Hinet IPv6 is Stateless (Stateless DHCPv6 + SLAAC) Disable the DHCPv6 service in the LAN 這樣做的邏輯是，IPv6 DNS 可以只向 IPv4 位址的 DNS 伺服器請求，還是會回傳 IPv6 的解析位址 安全性設定 Security System Disable the listen service including WebUI, ssh, Unbound on WAN surface Install the CrowdSec, and enable Intrusion Detection Disable hardware net acceleration related \u0026ldquo;Interfaces\u0026rdquo; \u0026gt; \u0026ldquo;Settings\u0026rdquo; Configure the SSH Key, disable the password login Intrusion Detection (Suricata) (IPS/IDS) Download rule sets based on service used Rule set with using sites name (p2p, Facebook, Youtube) do not apply ET Pro rule set need suscription Crowdesc Connected to the cloud database to detect the attackers IPs and block Collection for different scenarios (windows, nginx, \u0026hellip;)can only be added through shell command The hub for adding the scenario rule Hub | Firehol IP list subscription FireHOL Block List ( Botnets, Attacks, Malware\u0026hellip;.","keywords":["Linux","FreeBSD"],"articleBody":" 前言 更換了軟路由硬體故順便更新了筆記 此篇繼承了 Proxmox VE + PfSense 安裝 在 Proxmox VE 內的網路安裝架構仍然類似，皆採用半虛擬化網卡 Virtio Net 的架構 經過測試，Intel J4125 搭配 Intel i225v 網卡， 不用設定網卡直通，也可以跑滿 300M / 100M 更換成 OPNsense 原因有以下考量： PfSense 需要訂閱 (PfSense Plus) 才會獲得較積極的更新，雖然個人用戶目前免費，但不排除未來需付費可能 OPNsense 的更新策略較為積極，安全性更新週期較短 可安裝 Zenarmor 以及其他第三方套件來源，雖然後面還是把 Zenarmor 移除了 OPNsense 的 UI 比較人性化一些，可以善用搜尋快速跳到自己想要的設定欄位 初始安裝 Installation Assign the Port vmbr0 to WAN and vmbr1 to LAN (參見 PfSense 筆記內圖片) Skip the lagg and vlan configuration Default account and password for enter installation account: installer pass; opnsense Proxmox VE 內 VM 的設定 machine type: Q35 processors type: host OS type: other 其他 CPU, memory 視需求調整 設定 Configuration PPPoE settings with IPv6 (適用 Hinet) Fill out PPPoE info to establish connection Tick “Use IPv4 connectivity option” at LAN IPv6 section, IPv6 configuration type -\u003e Track Interface, and the options below interface select “WAN” In the Firewall options, Tick “allow IPv6” Add IPv6 ICMP allow rule in WAN firewall rule 如果想指定自架的 DNS (Adguard Home or Pi-Hole) 且想要應用到 IPv6: Tick the “Manual Router announcement management” Fill the DNS IPv4 settings in the “Router announcement” Hinet IPv6 is Stateless (Stateless DHCPv6 + SLAAC) Disable the DHCPv6 service in the LAN 這樣做的邏輯是，IPv6 DNS 可以只向 IPv4 位址的 DNS 伺服器請求，還是會回傳 IPv6 的解析位址 安全性設定 Security System Disable the listen service including WebUI, ssh, Unbound on WAN surface Install the CrowdSec, and enable Intrusion Detection Disable hardware net acceleration related “Interfaces” \u003e “Settings” Configure the SSH Key, disable the password login Intrusion Detection (Suricata) (IPS/IDS) Download rule sets based on service used Rule set with using sites name (p2p, Facebook, Youtube) do not apply ET Pro rule set need suscription Crowdesc Connected to the cloud database to detect the attackers IPs and block Collection for different scenarios (windows, nginx, …)can only be added through shell command The hub for adding the scenario rule Hub | Firehol IP list subscription FireHOL Block List ( Botnets, Attacks, Malware….) Follow the guide to add alias of Firehol level 2 Add the Cron tab to update the Firewall alias VLAN Configuration (適用於建立訪客網路或者 IoT 專用網路) Add VLAN, assign Tag, and make Proxmox VE vtnet aware vlan Assign DHCP server Add Firewall rule to make the VLAN network unable to access the LAN GeoIP and Ailases for Firewall Block (如果想擋特定區域國家的話) Register the Maxmind GeoIP database Follow the guide to add Firewall aliases Configure to block the specific countries Cron (安全性設定完成後，記得設定各列表的更新) System and packages update Suricata blocklist update Firewall aliases updates (FireHol, GeoIP) Others Packages Netdata: 另外一種監控服務 Wake-On-LAN: 遠端喚醒機器用 UPNP: 有安全疑慮者慎用，給 LAN 內服務打洞用的 Tailscale OPNsense安装配置Tailscale | 鐵血男兒的BLOG Wireguard How to Set Up WireGuard in OPNsense in 2023 - WunderTech ","wordCount":"422","inLanguage":"zh-tw","datePublished":"2023-01-29T18:46:18+08:00","dateModified":"2023-01-29T18:46:18+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://huyan.gbanyan.net/2023/01/opnsense-%E5%9C%A8-proxmox-ve-%E5%85%A7%E5%AE%89%E8%A3%9D%E7%AD%86%E8%A8%98/"},"publisher":{"@type":"Organization","name":"世界樹下，霍德爾之目","logo":{"@type":"ImageObject","url":"https://huyan.gbanyan.net/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://huyan.gbanyan.net accesskey=h title="世界樹下，霍德爾之目 (Alt + H)">世界樹下，霍德爾之目</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://huyan.gbanyan.net/about title=About><span>About</span></a></li><li><a href=https://huyan.gbanyan.net/tags title=Tags><span>Tags</span></a></li><li><a href=https://huyan.gbanyan.net/archives title=Archives><span>Archives</span></a></li><li><a href=https://huyan.gbanyan.net/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://huyan.gbanyan.net>首頁</a>&nbsp;»&nbsp;<a href=https://huyan.gbanyan.net/posts/>Posts</a></div><h1 class=post-title>OPNsense 在 Proxmox VE 內安裝筆記</h1><div class=post-meta><span title='2023-01-29 18:46:18 +0800 CST'>January 29, 2023</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目錄</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e5%88%9d%e5%a7%8b%e5%ae%89%e8%a3%9d-installation aria-label="初始安裝 Installation">初始安裝 Installation</a></li><li><a href=#%e8%a8%ad%e5%ae%9a-configuration aria-label="設定 Configuration">設定 Configuration</a><ul><li><a href=#pppoe-settings-with-ipv6--%e9%81%a9%e7%94%a8-hinet aria-label="PPPoE settings with IPv6  (適用 Hinet)">PPPoE settings with IPv6 (適用 Hinet)</a></li><li><a href=#%e5%ae%89%e5%85%a8%e6%80%a7%e8%a8%ad%e5%ae%9a-security aria-label="安全性設定 Security">安全性設定 Security</a><ul><li><a href=#system aria-label=System>System</a></li><li><a href=#intrusion-detection-suricata--ipsids aria-label="Intrusion Detection (Suricata)  (IPS/IDS)">Intrusion Detection (Suricata) (IPS/IDS)</a></li><li><a href=#crowdesc aria-label=Crowdesc>Crowdesc</a></li><li><a href=#firehol-ip-list-subscription aria-label="Firehol IP list subscription">Firehol IP list subscription</a></li><li><a href=#vlan-configuration--%e9%81%a9%e7%94%a8%e6%96%bc%e5%bb%ba%e7%ab%8b%e8%a8%aa%e5%ae%a2%e7%b6%b2%e8%b7%af%e6%88%96%e8%80%85-iot-%e5%b0%88%e7%94%a8%e7%b6%b2%e8%b7%af aria-label="VLAN Configuration  (適用於建立訪客網路或者 IoT 專用網路)">VLAN Configuration (適用於建立訪客網路或者 IoT 專用網路)</a></li><li><a href=#geoip-and-ailases-for-firewall-block--%e5%a6%82%e6%9e%9c%e6%83%b3%e6%93%8b%e7%89%b9%e5%ae%9a%e5%8d%80%e5%9f%9f%e5%9c%8b%e5%ae%b6%e7%9a%84%e8%a9%b1 aria-label="GeoIP and Ailases for Firewall Block  (如果想擋特定區域國家的話)">GeoIP and Ailases for Firewall Block (如果想擋特定區域國家的話)</a></li></ul></li><li><a href=#cron-%e5%ae%89%e5%85%a8%e6%80%a7%e8%a8%ad%e5%ae%9a%e5%ae%8c%e6%88%90%e5%be%8c%e8%a8%98%e5%be%97%e8%a8%ad%e5%ae%9a%e5%90%84%e5%88%97%e8%a1%a8%e7%9a%84%e6%9b%b4%e6%96%b0 aria-label="Cron (安全性設定完成後，記得設定各列表的更新)">Cron (安全性設定完成後，記得設定各列表的更新)</a></li><li><a href=#others-packages aria-label="Others Packages">Others Packages</a></li></ul></li></ul></div></details></div><div class=post-content><ul><li><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><ul><li>更換了軟路由硬體故順便更新了筆記</li><li>此篇繼承了 <a href=https://huyan.gbanyan.net/2022/08/proxmox-ve--pfsense-%E5%AE%89%E8%A3%9D/>Proxmox VE + PfSense 安裝</a><ul><li>在 Proxmox VE 內的網路安裝架構仍然類似，皆採用半虛擬化網卡 Virtio Net 的架構</li><li>經過測試，Intel J4125 搭配 Intel i225v 網卡， 不用設定網卡直通，也可以跑滿 300M / 100M</li></ul></li><li>更換成 OPNsense 原因有以下考量：<ul><li>PfSense 需要訂閱 (PfSense Plus) 才會獲得較積極的更新，雖然個人用戶目前免費，但不排除未來需付費可能</li><li>OPNsense 的更新策略較為積極，安全性更新週期較短</li><li>可安裝 Zenarmor 以及其他第三方套件來源，雖然後面還是把 Zenarmor 移除了</li><li>OPNsense 的 UI 比較人性化一些，可以善用搜尋快速跳到自己想要的設定欄位</li></ul></li></ul></li><li><h2 id=初始安裝-installation>初始安裝 Installation<a hidden class=anchor aria-hidden=true href=#初始安裝-installation>#</a></h2><ul><li>Assign the Port vmbr0 to WAN and vmbr1 to LAN (參見 PfSense 筆記內圖片)</li><li>Skip the lagg and vlan configuration</li><li>Default account and password for enter installation<ul><li>account: installer</li><li>pass; opnsense</li></ul></li><li>Proxmox VE 內 VM 的設定<ul><li>machine type: Q35</li><li>processors type: host</li><li>OS type: other</li><li>其他 CPU, memory 視需求調整</li></ul></li></ul></li><li><h2 id=設定-configuration>設定 Configuration<a hidden class=anchor aria-hidden=true href=#設定-configuration>#</a></h2><ul><li><h3 id=pppoe-settings-with-ipv6--適用-hinet>PPPoE settings with IPv6 (適用 Hinet)<a hidden class=anchor aria-hidden=true href=#pppoe-settings-with-ipv6--適用-hinet>#</a></h3><ul><li>Fill out PPPoE info to establish connection</li><li>Tick &ldquo;Use IPv4 connectivity option&rdquo;</li><li>at LAN IPv6 section, IPv6 configuration type -> Track Interface, and the options below interface select &ldquo;WAN&rdquo;</li><li>In the Firewall options, Tick &ldquo;allow IPv6&rdquo;</li><li>Add IPv6 ICMP allow rule in WAN firewall rule</li><li>如果想指定自架的 DNS (Adguard Home or Pi-Hole) 且想要應用到 IPv6:<ul><li>Tick the &ldquo;Manual Router announcement management&rdquo;</li><li>Fill the DNS IPv4 settings in the &ldquo;Router announcement&rdquo;</li><li>Hinet IPv6 is Stateless (Stateless DHCPv6 + SLAAC)</li><li>Disable the DHCPv6 service in the LAN</li><li>這樣做的邏輯是，IPv6 DNS 可以只向 IPv4 位址的 DNS 伺服器請求，還是會回傳 IPv6 的解析位址</li></ul></li></ul></li><li><h3 id=安全性設定-security>安全性設定 Security<a hidden class=anchor aria-hidden=true href=#安全性設定-security>#</a></h3><ul><li><h4 id=system>System<a hidden class=anchor aria-hidden=true href=#system>#</a></h4><ul><li>Disable the listen service including WebUI, ssh, Unbound on WAN surface</li><li>Install the CrowdSec, and enable Intrusion Detection<ul><li>Disable hardware net acceleration related &ldquo;Interfaces&rdquo; > &ldquo;Settings&rdquo;</li></ul></li><li>Configure the SSH Key, disable the password login</li></ul></li><li><h4 id=intrusion-detection-suricata--ipsids>Intrusion Detection (Suricata) (IPS/IDS)<a hidden class=anchor aria-hidden=true href=#intrusion-detection-suricata--ipsids>#</a></h4><ul><li>Download rule sets based on service used</li><li>Rule set with using sites name (p2p, Facebook, Youtube) do not apply</li><li>ET Pro rule set need suscription</li></ul></li><li><h4 id=crowdesc>Crowdesc<a hidden class=anchor aria-hidden=true href=#crowdesc>#</a></h4><ul><li>Connected to the cloud database to detect the attackers IPs and block</li><li>Collection for different scenarios (windows, nginx, &mldr;)can only be added through shell command</li><li>The hub for adding the scenario rule <a href=https://hub.crowdsec.net>Hub |</a></li></ul></li><li><h4 id=firehol-ip-list-subscription>Firehol IP list subscription<a hidden class=anchor aria-hidden=true href=#firehol-ip-list-subscription>#</a></h4><ul><li><a href="https://forum.opnsense.org/index.php?topic=17596.0">FireHOL Block List ( Botnets, Attacks, Malware&mldr;.)</a></li><li>Follow the guide to add alias of Firehol level 2</li><li>Add the Cron tab to update the Firewall alias</li></ul></li><li><h4 id=vlan-configuration--適用於建立訪客網路或者-iot-專用網路>VLAN Configuration (適用於建立訪客網路或者 IoT 專用網路)<a hidden class=anchor aria-hidden=true href=#vlan-configuration--適用於建立訪客網路或者-iot-專用網路>#</a></h4><ul><li>Add VLAN, assign Tag, and make Proxmox VE vtnet aware vlan</li><li>Assign DHCP server</li><li>Add Firewall rule to make the VLAN network unable to access the LAN</li></ul></li><li><h4 id=geoip-and-ailases-for-firewall-block--如果想擋特定區域國家的話>GeoIP and Ailases for Firewall Block (如果想擋特定區域國家的話)<a hidden class=anchor aria-hidden=true href=#geoip-and-ailases-for-firewall-block--如果想擋特定區域國家的話>#</a></h4><ul><li>Register the Maxmind GeoIP database</li><li>Follow the guide to add Firewall aliases</li><li>Configure to block the specific countries</li></ul></li></ul></li><li><h3 id=cron-安全性設定完成後記得設定各列表的更新>Cron (安全性設定完成後，記得設定各列表的更新)<a hidden class=anchor aria-hidden=true href=#cron-安全性設定完成後記得設定各列表的更新>#</a></h3><ul><li>System and packages update</li><li>Suricata blocklist update</li><li>Firewall aliases updates (FireHol, GeoIP)</li></ul></li><li><h3 id=others-packages>Others Packages<a hidden class=anchor aria-hidden=true href=#others-packages>#</a></h3><ul><li>Netdata: 另外一種監控服務</li><li>Wake-On-LAN: 遠端喚醒機器用</li><li>UPNP: 有安全疑慮者慎用，給 LAN 內服務打洞用的</li><li>Tailscale <a href="https://pfschina.org/wp/?p=9163">OPNsense安装配置Tailscale | 鐵血男兒的BLOG</a></li><li>Wireguard <a href=https://www.wundertech.net/how-to-set-up-wireguard-in-opnsense/>How to Set Up WireGuard in OPNsense in 2023 - WunderTech</a></li></ul></li></ul></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://huyan.gbanyan.net/tags/linux/>Linux</a></li><li><a href=https://huyan.gbanyan.net/tags/freebsd/>FreeBSD</a></li></ul><nav class=paginav><a class=prev href=https://huyan.gbanyan.net/2023/01/edema-%E6%B0%B4%E8%85%AB%E6%A6%82%E8%AB%96/><span class=title>« 上一頁</span><br><span>Edema 水腫概論</span></a>
<a class=next href=https://huyan.gbanyan.net/2022/09/dark-mode-%E9%BB%91%E5%8C%96%E6%8C%87%E5%8D%97/><span class=title>下一頁 »</span><br><span>Dark Mode 黑化指南</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share OPNsense 在 Proxmox VE 內安裝筆記 on twitter" href="https://twitter.com/intent/tweet/?text=OPNsense%20%e5%9c%a8%20Proxmox%20VE%20%e5%85%a7%e5%ae%89%e8%a3%9d%e7%ad%86%e8%a8%98&url=https%3a%2f%2fhuyan.gbanyan.net%2f2023%2f01%2fopnsense-%25E5%259C%25A8-proxmox-ve-%25E5%2585%25A7%25E5%25AE%2589%25E8%25A3%259D%25E7%25AD%2586%25E8%25A8%2598%2f&hashtags=Linux%2cFreeBSD"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OPNsense 在 Proxmox VE 內安裝筆記 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fhuyan.gbanyan.net%2f2023%2f01%2fopnsense-%25E5%259C%25A8-proxmox-ve-%25E5%2585%25A7%25E5%25AE%2589%25E8%25A3%259D%25E7%25AD%2586%25E8%25A8%2598%2f&title=OPNsense%20%e5%9c%a8%20Proxmox%20VE%20%e5%85%a7%e5%ae%89%e8%a3%9d%e7%ad%86%e8%a8%98&summary=OPNsense%20%e5%9c%a8%20Proxmox%20VE%20%e5%85%a7%e5%ae%89%e8%a3%9d%e7%ad%86%e8%a8%98&source=https%3a%2f%2fhuyan.gbanyan.net%2f2023%2f01%2fopnsense-%25E5%259C%25A8-proxmox-ve-%25E5%2585%25A7%25E5%25AE%2589%25E8%25A3%259D%25E7%25AD%2586%25E8%25A8%2598%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OPNsense 在 Proxmox VE 內安裝筆記 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhuyan.gbanyan.net%2f2023%2f01%2fopnsense-%25E5%259C%25A8-proxmox-ve-%25E5%2585%25A7%25E5%25AE%2589%25E8%25A3%259D%25E7%25AD%2586%25E8%25A8%2598%2f&title=OPNsense%20%e5%9c%a8%20Proxmox%20VE%20%e5%85%a7%e5%ae%89%e8%a3%9d%e7%ad%86%e8%a8%98"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OPNsense 在 Proxmox VE 內安裝筆記 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhuyan.gbanyan.net%2f2023%2f01%2fopnsense-%25E5%259C%25A8-proxmox-ve-%25E5%2585%25A7%25E5%25AE%2589%25E8%25A3%259D%25E7%25AD%2586%25E8%25A8%2598%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OPNsense 在 Proxmox VE 內安裝筆記 on whatsapp" href="https://api.whatsapp.com/send?text=OPNsense%20%e5%9c%a8%20Proxmox%20VE%20%e5%85%a7%e5%ae%89%e8%a3%9d%e7%ad%86%e8%a8%98%20-%20https%3a%2f%2fhuyan.gbanyan.net%2f2023%2f01%2fopnsense-%25E5%259C%25A8-proxmox-ve-%25E5%2585%25A7%25E5%25AE%2589%25E8%25A3%259D%25E7%25AD%2586%25E8%25A8%2598%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share OPNsense 在 Proxmox VE 內安裝筆記 on telegram" href="https://telegram.me/share/url?text=OPNsense%20%e5%9c%a8%20Proxmox%20VE%20%e5%85%a7%e5%ae%89%e8%a3%9d%e7%ad%86%e8%a8%98&url=https%3a%2f%2fhuyan.gbanyan.net%2f2023%2f01%2fopnsense-%25E5%259C%25A8-proxmox-ve-%25E5%2585%25A7%25E5%25AE%2589%25E8%25A3%259D%25E7%25AD%2586%25E8%25A8%2598%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://huyan.gbanyan.net>世界樹下，霍德爾之目</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="複製";function s(){t.innerHTML="已複製！",setTimeout(()=>{t.innerHTML="複製"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>